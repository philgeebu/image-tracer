<template>
    <canvas
        :style="'opacity: ' + storeTracing.tracingOpacity"
        :width="storeTracing.canvasWidth + 40"
        :height="storeTracing.canvasHeight + 40"
        ref="tracingCanvas"
        @mousedown="onMouseDown($event)"
        @mousemove="onMouseMove($event)"
        @mouseup="onMouseUp($event)"
    >
    </canvas>
    <img :src="imageSource" :style="'opacity: ' + storeTracing.imageOpacity" />
    <div
        class="whiteCanvasBackground"
        :style="
            'width: ' +
            (storeTracing.canvasWidth + 40) +
            'px; height: ' +
            (storeTracing.canvasHeight + 40) +
            'px;'
        "
    ></div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue';
import { useRouter } from 'vue-router';
import { useContextStore } from '../stores/ContextStore';
import { useTracingStore } from '../stores/TracingStore';

const router = useRouter();
const storeContext = useContextStore();
const storeTracing = useTracingStore();

const tracingCanvas = ref<HTMLCanvasElement>();
const x = ref(0);
const y = ref(0);
const isDrawing = ref(false);
const imageSource = ref<string>();

const drawLine = (
    context: any,
    x1: number,
    y1: number,
    x2: number,
    y2: number
) => {
    context.beginPath();
    context.moveTo(x1, y1);
    context.lineTo(x2, y2);
    context.stroke();
    context.closePath();
};

const onMouseDown = (e: any) => {
    x.value = e.offsetX;
    y.value = e.offsetY;
    isDrawing.value = true;
};

const onMouseMove = (e: any) => {
    if (isDrawing.value === true) {
        drawLine(
            storeContext.tracingContext,
            x.value,
            y.value,
            e.offsetX,
            e.offsetY
        );
        x.value = e.offsetX;
        y.value = e.offsetY;
    }
};

const onMouseUp = (e: any) => {
    if (isDrawing.value === true) {
        drawLine(
            storeContext.tracingContext,
            x.value,
            y.value,
            e.offsetX,
            e.offsetY
        );
        x.value = 0;
        y.value = 0;
        isDrawing.value = false;
    }
};

onMounted(() => {
    storeTracing.canvasElement = tracingCanvas.value;
    storeContext.tracingContext = storeTracing.canvasElement.getContext('2d');
});

watch(
    storeTracing.getCurrentTracing,
    async (newValue: any) => {
        if (!newValue || !newValue.imageID) return router.push('/');
        else {
            const response = await fetch(
                `https://pixabay.com/api/?key=30198755-511fed12f4c341988f11b1a00&id=${storeTracing.currentTracing.imageID}`
            );

            const data = await response.json();

            imageSource.value = data.hits[0].webformatURL;
            storeTracing.canvasWidth = data.hits[0].webformatWidth;
            storeTracing.canvasHeight = data.hits[0].webformatHeight;

            storeContext.resetStrokeStyle();
            storeTracing.resetImageOpacity();
            storeTracing.resetTracingOpacity();
            storeContext.tracingContext.clearRect(
                0,
                0,
                storeTracing.canvasWidth,
                storeTracing.canvasHeight
            );

            if (newValue.canvas) {
                storeContext.tracingContext.drawImage(newValue.canvas, 0, 0);
            }
        }
    },
    { immediate: true }
);
</script>

<style scoped>
canvas {
    cursor: pointer;
    position: absolute;
    z-index: 9;
}
img {
    border: 20px white solid;
    position: absolute;
    z-index: 8;
}
.whiteCanvasBackground {
    background-color: white;
    position: relative;
}
</style>
